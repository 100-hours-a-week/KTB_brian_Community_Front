<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>회원가입 - 컴포넌트 기반</title>
    <style>
        /* ===================== 0) Design Tokens ===================== */
        :root {
            /* colors */
            --bg-page: #F4F5F7;
            --bg-surface: #FFFFFF;
            --text: #000000;
            --muted: #6b6b6b;
            --primary: #ACA0EB;
            --line: #000000;

            /* radius */
            --r-sm: 4px;
            --r-lg: 16px;

            /* spacing (4px grid) */
            --s-1: 4px;
            --s-2: 8px;
            --s-3: 12px;
            --s-4: 16px;
            --s-5: 20px;
            --s-6: 24px;
            --s-8: 32px;
            --s-10: 40px;

            /* typography */
            --font-body: 'Pretendard', system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, 'Apple SD Gothic Neo', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            --font-display: 'Sandoll GogoRound', var(--font-body);
            --fs-12: 12px;
            --fs-14: 14px;
            --fs-15: 15px;
            --fs-16: 16px;
            --fs-24: 24px;
            --fs-32: 32px;
            --lh-100: 100%;
            --lh-130: 130%;

            /* layout */
            --container-max: 920px;
            --container-pt: var(--s-6);
            --header-h: 104px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: #eaeaea;
            color: var(--text);
            font-family: var(--font-body);
        }

        /* ===================== 1) Page Shell ===================== */
        .app {
            min-height: 100%;
            background: var(--bg-surface);
        }

        /* Header (공통) */
        .header {
            position: sticky;
            top: 0;
            z-index: 10;
            height: var(--header-h);
            background: var(--bg-page);
            border-bottom: 1px solid var(--line);
        }

        .header__inner {
            max-width: var(--container-max);
            height: 100%;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .header__title {
            font-family: var(--font-display);
            font-size: var(--fs-32);
            line-height: var(--lh-100);
            font-weight: 400;
            white-space: nowrap;
        }

        /* 뒤로가기 아이콘 버튼 (40x40) */
        .icon-btn {
            position: absolute;
            left: 0;
            display: inline-grid;
            place-items: center;
            width: 40px;
            height: 40px;
            border-radius: var(--r-sm);
            background: transparent;
            border: none;
            cursor: pointer;
        }

        .icon-btn svg {
            display: block;
            width: 11px;
            height: 19px;
        }

        /* Container */
        .container {
            max-width: var(--container-max);
            margin: 0 auto;
            padding: var(--container-pt) var(--s-6) var(--s-8);
        }

        /* ===================== 2) Components ===================== */
        .page-title {
            margin-top: calc(265px - var(--header-h) - var(--container-pt));
            text-align: center;
            font-weight: 700;
            font-size: var(--fs-32);
            line-height: var(--lh-100);
            margin-bottom: var(--s-8);
        }

        /* Form shell */
        .form {
            max-width: 355px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: var(--s-6);
        }

        /* Field (Label + Input + Helper) */
        .field {
            display: flex;
            flex-direction: column;
        }

        .field__label {
            font-weight: 700;
            font-size: var(--fs-15);
            line-height: var(--lh-100);
            margin-bottom: var(--s-2);
        }

        .field__input {
            height: 33px;
            border: 1px solid var(--line);
            border-radius: var(--r-sm);
            padding: 6px 10px;
            font-size: var(--fs-14);
            margin-bottom: var(--s-1);
        }

        .field__input::placeholder {
            color: var(--muted);
        }

        .field__helper {
            margin: 0;
            font-family: 'Inter', var(--font-body);
            font-size: var(--fs-12);
            color: #FF0000;
            line-height: var(--lh-100);
            min-height: 15px;
            visibility: hidden;
        }

        .field.field--error .field__helper,
        .field.field--warn .field__helper,
        .field.field--info .field__helper {
            visibility: visible;
        }

        .field.field--error .field__input {
            border-color: #FF0000;
            outline: none;
        }

        /* Profile Picker (원형 149x149) */
        .profile {
            display: flex;
            flex-direction: column;
            gap: var(--s-2);
            align-items: center;
        }

        .profile__label {
            font-weight: 700;
            font-size: var(--fs-15);
        }

        .profile__helper {
            margin: 0;
            font-family: 'Inter', var(--font-body);
            font-size: var(--fs-12);
            color: #FF0000;
            line-height: var(--lh-100);
            min-height: 15px;
            visibility: hidden;
        }

        .profile__upload {
            position: relative;
            width: 149px;
            height: 149px;
            border-radius: 50%;
            background: #C4C4C4;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .profile__upload input[type="file"] {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
            display: block;
        }

        .profile__upload.has-image {
            background: none;
        }

        .profile__upload.has-image .profile__preview {
            display: block;
        }

        .profile__upload.has-image .profile__plus {
            display: none;
        }

        .profile__preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .profile__plus {
            pointer-events: none;
            position: absolute;
            width: 24px;
            height: 24px;
        }

        /* Actions */
        .actions {
            display: flex;
            flex-direction: column;
            gap: var(--s-4);
            margin-top: var(--s-6);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 33px;
            padding: 6px 10px;
            border-radius: var(--r-sm);
            border: 1px solid transparent;
            cursor: pointer;
            font-weight: 700;
            font-size: var(--fs-14);
        }

        .btn--primary {
            background: var(--primary);
            color: #000;
        }

        .btn--primary:disabled,
        .btn--primary[disabled] {
            opacity: .5;
            cursor: not-allowed;
        }

        .btn--primary.is-active {
            background: #7F6AEE;
            color: #fff;
        }

        .btn--outline {
            background: transparent;
            color: var(--text);
            border-color: var(--line);
        }

        .btn--block {
            width: 100%;
        }
    </style>
</head>

<body>
    <div class="app">
        <!-- 헤더 -->
        <header class="header" role="banner">
            <div class="header__inner">
                <button class="icon-btn" type="button" aria-label="뒤로가기">
                    <svg viewBox="0 0 11 19" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M10 1 L2 9 L10 17" stroke="#000" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </button>
                <h1 class="header__title">아무 말 대잔치</h1>
            </div>
        </header>

        <!-- 본문 -->
        <main class="container" role="main">
            <h2 class="page-title">회원가입</h2>

            <form class="form" action="#" method="post" novalidate>
                <!-- 프로필 -->
                <section class="profile" aria-label="프로필 사진">
                    <label class="profile__label" for="profile">프로필 사진</label>
                    <p class="profile__helper" id="profile-help">* 프로필 사진을 추가해주세요.</p>
                    <div class="profile__upload" data-required="true" aria-describedby="profile-help">
                        <img class="profile__preview" alt="프로필 미리보기" />
                        <input id="profile" name="profile" type="file" accept="image/*" />
                        <svg class="profile__plus" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
                            aria-hidden="true">
                            <rect x="11.5" y="4" width="1" height="16" fill="#000" />
                            <rect x="4" y="11.5" width="16" height="1" fill="#000" />
                        </svg>
                    </div>
                </section>

                <!-- 이메일 -->
                <div class="field" id="field-email">
                    <label class="field__label" for="email">이메일*</label>
                    <input class="field__input" id="email" name="email" type="email" placeholder="이메일을 입력하세요"
                        data-required="true" data-rule="email" aria-describedby="email-help" />
                    <p class="field__helper" id="email-help"></p>
                </div>

                <!-- 비밀번호 -->
                <div class="field" id="field-password">
                    <label class="field__label" for="password">비밀번호*</label>
                    <input class="field__input" id="password" name="password" type="password" placeholder="비밀번호를 입력하세요"
                        data-required="true" data-rule="password" aria-describedby="password-help" />
                    <p class="field__helper" id="password-help"></p>
                </div>

                <!-- 비밀번호 확인 -->
                <div class="field" id="field-password2">
                    <label class="field__label" for="password2">비밀번호 확인*</label>
                    <input class="field__input" id="password2" name="password2" type="password"
                        placeholder="비밀번호를 한 번 더 입력하세요" data-required="true" data-rule="password2"
                        aria-describedby="password2-help" />
                    <p class="field__helper" id="password2-help"></p>
                </div>

                <!-- 닉네임 -->
                <div class="field" id="field-nickname">
                    <label class="field__label" for="nickname">닉네임*</label>
                    <input class="field__input" id="nickname" name="nickname" type="text" placeholder="닉네임을 입력하세요"
                        data-required="true" data-rule="nickname" aria-describedby="nickname-help" />
                    <p class="field__helper" id="nickname-help"></p>
                </div>

                <!-- 버튼 -->
                <div class="actions">
                    <button class="btn btn--primary btn--block" id="signup-btn" type="submit" disabled>회원가입</button>
                    <a class="btn btn--outline btn--block" href="/login">로그인하러 가기</a>
                </div>
            </form>
        </main>
    </div>

    <script>
        (function () {
            const form = document.querySelector('.form');
            const btn = document.getElementById('signup-btn');

            /* ===== 프로필 미리보기 + 클릭영역 전체 활성 ===== */
            const profileWrap = document.querySelector('.profile__upload');
            const profileInput = document.getElementById('profile');
            const profileImg = document.querySelector('.profile__preview');
            const profileHelper = document.getElementById('profile-help');

            profileInput.addEventListener('change', () => {
                const file = profileInput.files && profileInput.files[0];
                if (!file) { updateSubmitState(); return; }
                const url = URL.createObjectURL(file);
                profileImg.src = url;
                profileImg.onload = () => URL.revokeObjectURL(url);
                profileWrap.classList.add('has-image');
                setProfileHelper(true); // 성공적으로 업로드되면 helper 숨김
                updateSubmitState();
            });

            function setProfileHelper(ok) {
                // profile은 field 구조가 아니라 profile 섹션에 직접 표시
                if (!ok) {
                    profileHelper.style.visibility = 'visible';
                    profileHelper.textContent = '*프로필 사진을 추가해주세요.';
                } else {
                    profileHelper.style.visibility = 'hidden';
                    profileHelper.textContent = '';
                }
            }
            function validateProfile(showMsg = false) {
                const hasImage = profileWrap.classList.contains('has-image');
                if (!hasImage && showMsg) setProfileHelper(false);
                if (hasImage) setProfileHelper(true);
                return hasImage;
            }

            /* ===== 공용 유틸 ===== */
            const EMAIL_RE = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const PW_RE = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\w\s]).{8,20}$/; // 8~20, 대/소/숫/특
            const hasWhitespace = (s) => /\s/.test(s || '');
            const withinLen = (s, max) => (s || '').length <= max;

            function setHelper(fieldEl, helpEl, msg, level = 'error') {
                fieldEl.classList.remove('field--error', 'field--warn', 'field--info');
                helpEl.textContent = '';
                if (level && msg) {
                    fieldEl.classList.add(`field--${level}`);
                    helpEl.textContent = msg;
                }
            }

            /* ===== 가용성(중복) 체크 API (debounce + abort) ===== */
            function makeAvailabilityChecker(paramKey) {
                let timer = null;
                let controller = null;
                return function (value, cb) {
                    clearTimeout(timer);
                    if (controller) controller.abort();
                    if (!value) { cb({ ok: false, duplicate: false, reason: 'empty' }); return; }
                    timer = setTimeout(async () => {
                        try {
                            controller = new AbortController();
                            const url = `http://localhost:8080/users/availability?${paramKey}=` + encodeURIComponent(value);
                            const res = await fetch(url, { signal: controller.signal });
                            if (!res.ok) { cb({ ok: false, duplicate: false, reason: 'http' }); return; }
                            // 서버 응답 형식 가정: { available: boolean }
                            const data = await res.json();
                            cb({ ok: true, duplicate: data.available === false });
                        } catch (e) {
                            if (e.name === 'AbortError') return;
                            cb({ ok: false, duplicate: false, reason: 'network' });
                        }
                    }, 300);
                };
            }
            const checkEmailDup = makeAvailabilityChecker('email');
            const checkNickDup = makeAvailabilityChecker('nickname');

            /* ===== 필드 참조 ===== */
            const fieldEmail = document.getElementById('field-email');
            const inputEmail = document.getElementById('email');
            const helpEmail = document.getElementById('email-help');

            const fieldPw = document.getElementById('field-password');
            const inputPw = document.getElementById('password');
            const helpPw = document.getElementById('password-help');

            const fieldPw2 = document.getElementById('field-password2');
            const inputPw2 = document.getElementById('password2');
            const helpPw2 = document.getElementById('password2-help');

            const fieldNick = document.getElementById('field-nickname');
            const inputNick = document.getElementById('nickname');
            const helpNick = document.getElementById('nickname-help');

            /* ===== 각 필드 검증 ===== */
            function validateEmail({ asyncDupCheck = false, showMsg = false } = {}) {
                const v = (inputEmail.value || '').trim();
                if (!v) { if (showMsg) setHelper(fieldEmail, helpEmail, '*이메일을 입력해주세요.', 'error'); return false; }
                if (v.length < 5 || !EMAIL_RE.test(v)) {
                    if (showMsg) setHelper(fieldEmail, helpEmail, '*올바른 이메일 주소 형식을 입력해주세요.(예: example@example.com)', 'error');
                    return false;
                }
                setHelper(fieldEmail, helpEmail, null, null);
                if (asyncDupCheck) {
                    checkEmailDup(v, (res) => {
                        if (!res.ok) { setHelper(fieldEmail, helpEmail, '이메일 중복 확인에 실패했습니다. 잠시 후 다시 시도해주세요.', 'warn'); updateSubmitState(); return; }
                        if (res.duplicate) setHelper(fieldEmail, helpEmail, '*중복된 이메일입니다.', 'error');
                        else setHelper(fieldEmail, helpEmail, null, null);
                        updateSubmitState();
                    });
                }
                return true;
            }

            function validatePassword(showMsg = false) {
                const v = inputPw.value || '';
                if (!v) { if (showMsg) setHelper(fieldPw, helpPw, '*비밀번호를 입력해주세요', 'error'); return false; }
                if (!PW_RE.test(v)) {
                    if (showMsg) setHelper(fieldPw, helpPw, '*8~20자, 대문자·소문자·숫자·특수문자 각각 1개 이상 포함해야 합니다.', 'error');
                    return false;
                }
                setHelper(fieldPw, helpPw, null, null);
                return true;
            }

            function validatePassword2(showMsg = false) {
                const v2 = inputPw2.value || '';
                const v1 = inputPw.value || '';
                if (!v2) { if (showMsg) setHelper(fieldPw2, helpPw2, '*비밀번호를 한 번 더 입력해주세요', 'error'); return false; }
                if (v2 !== v1) { if (showMsg) setHelper(fieldPw2, helpPw2, '*비밀번호가 다릅니다', 'error'); return false; }
                setHelper(fieldPw2, helpPw2, null, null);
                return true;
            }

            function validateNickname({ asyncDupCheck = false, showMsg = false } = {}) {
                const v = inputNick.value || '';
                if (!v.trim()) { if (showMsg) setHelper(fieldNick, helpNick, '*닉네임을 입력해주세요', 'error'); return false; }
                if (hasWhitespace(v)) { if (showMsg) setHelper(fieldNick, helpNick, '*띄어쓰기를 없애주세요', 'error'); return false; }
                if (!withinLen(v, 10)) { if (showMsg) setHelper(fieldNick, helpNick, '*닉네임은 최대 10자까지 작성 가능합니다', 'error'); return false; }
                setHelper(fieldNick, helpNick, null, null);
                if (asyncDupCheck) {
                    checkNickDup(v, (res) => {
                        if (!res.ok) { setHelper(fieldNick, helpNick, '닉네임 중복 확인에 실패했습니다. 잠시 후 다시 시도해주세요.', 'warn'); updateSubmitState(); return; }
                        if (res.duplicate) setHelper(fieldNick, helpNick, '*중복된 닉네임입니다.', 'error');
                        else setHelper(fieldNick, helpNick, null, null);
                        updateSubmitState();
                    });
                }
                return true;
            }

            /* ===== 제출 버튼 활성/비활성 ===== */
            function isAllValidSync() {
                const okProfile = profileWrap.classList.contains('has-image');
                const okEmail = validateEmail({ asyncDupCheck: false, showMsg: false });
                const okPw = validatePassword(false);
                const okPw2 = validatePassword2(false);
                const okNick = validateNickname({ asyncDupCheck: false, showMsg: false });

                const hasAnyError =
                    document.querySelector('.field.field--error') ||
                    (profileHelper.style.visibility === 'visible');

                return okProfile && okEmail && okPw && okPw2 && okNick && !hasAnyError;
            }
            function updateSubmitState() {
                const enabled = isAllValidSync();
                btn.disabled = !enabled;
                btn.classList.toggle('is-active', enabled);
            }

            /* ===== 이벤트 바인딩 ===== */
            inputEmail.addEventListener('blur', () => { validateEmail({ asyncDupCheck: true, showMsg: true }); updateSubmitState(); });
            inputEmail.addEventListener('input', () => { validateEmail({ asyncDupCheck: true, showMsg: false }); updateSubmitState(); });

            inputPw.addEventListener('blur', () => { validatePassword(true); validatePassword2(true); updateSubmitState(); });
            inputPw.addEventListener('input', () => { validatePassword(false); validatePassword2(false); updateSubmitState(); });

            inputPw2.addEventListener('blur', () => { validatePassword2(true); updateSubmitState(); });
            inputPw2.addEventListener('input', () => { validatePassword2(false); updateSubmitState(); });

            inputNick.addEventListener('blur', () => { validateNickname({ asyncDupCheck: true, showMsg: true }); updateSubmitState(); });
            inputNick.addEventListener('input', () => { validateNickname({ asyncDupCheck: true, showMsg: false }); updateSubmitState(); });

            // 첫 로드 상태
            updateSubmitState();

            // 폼 제출 최종 검증
            form.addEventListener('submit', (e) => {
                const ok = validateProfile(true) &
                    validateEmail({ asyncDupCheck: true, showMsg: true }) &
                    validatePassword(true) &
                    validatePassword2(true) &
                    validateNickname({ asyncDupCheck: true, showMsg: true });
                updateSubmitState();
                if (!isAllValidSync() || !ok) { e.preventDefault(); e.stopPropagation(); }
            });
        })();
    </script>
</body>

</html>